<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>双节万元刮刮送</title>
<meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta content="telephone=no" name="format-detection" />
<link rel="stylesheet" href="<?php echo $base_url;?>css/ggc_style.css" />
<style type="text/css">

</style>
</head>
<body>
	<div class="bonus-total">
		<div class="bonus-tit">累计奖金：</div>
		<div id="bonusTotal" class="bonus-num"></div>
		<a javascript:void(0); class="btn-notice" id="btnNotice">活动规则</a>
	</div>
	<div class="banner">
		<img src="<?php echo $base_url;?>images/ggc_banner.jpg" alt="双节万元刮刮送">
	</div>
	<div class="bg-moon">
		<div class="step-wrap">
			<ul class="step-list" id="stepList">
				<li class="step1">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="rabbit"></div>
				</li>
				<li class="step2">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step3">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step4">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step5">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step6">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step7">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step8">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step9">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step10">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step11">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step12">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step13">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step14">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step15">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step16">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step17">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step18">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step19">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step20">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step21">
					<img src="<?php echo $base_url;?>images/ggc_ico-step.png" alt="">
					<i class="ico-line"></i>
					<div class="box box-lock"></div>
					<div class="card"><strong></strong>元</div>
				</li>
				<li class="step22">
					<img src="<?php echo $base_url;?>images/ggc_ico-cup.png" alt="">
					<div class="cup-info">奖金高达<br /><strong>11,888</strong>元</div>
				</li>
			</ul>
			<div class="rabbit rabbit-current" id="rabbit">
				<p class="bettot-info">累计：<span id="betTotal">0</span>元</p>
			</div>
			<p id="amountInfo" class="amount-info"><span id="bounsTit"></span> : <span id="bounsNum">9999</span>元<br />投注目标 : <span id="betExpect"></span>元</p>
			<!-- <p id="amountInfoCup" class="amount-info amount-info-cup">投注目标 : <span id="betExpectCup"></span>元</p> -->
			<div class="flag"></div>
			<div class="ufo">
				<div class="jet"></div>
			</div>
		</div>
	</div>
	<div id="pop" class="pop">
		<div  class="scratcher-wrap">
			<div id="scratcher" class="scratcher">
				<div class="scratcher-info"><strong id="bounsScratcher">99</strong>元</div>
				<canvas id="canvas"></canvas>
			</div>
		</div>
		<p id="popInfo" class="pop-info">刮一刮 赢奖金</p>
		<a id="popBtn" class="pop-btn" href="javascript:void();">确认</a>
	</div>
	<div id="popCup" class="pop pop-cup">
		<img src="<?php echo $base_url;?>images/ggc_bg-cup.png" alt="">
		<p class="pop-info">恭喜你获得了<strong>11888</strong>元</p>
		<a class="pop-btn" href="javascript:void();">确认</a>
	</div>
	<div id="popNotice" class="pop pop-notice">
		<p class="pop-info">1.活动期间（仅）在宝开手机端进行投注，累积金额达指定等级即可解锁“国庆刮刮卡”。<br />2.当日投注的金额将在次日13点左右更新至累计金额内，若达到相应等级则立即解锁刮刮卡。<br />3.点击刮刮卡可以参与刮奖，刮中的奖金由平台即刻派发至帐户。<br />4.投注金额只累计 自2015年9月25日00：00：00至2015年10月8日23：59：59内的用户投注。<br />5.领取刮刮卡截止时间为2015年10月15日23：59：59，之后未领取的刮刮卡视为用户主动放弃奖励。<br />6.活动期间禁止任何刷量、作弊行为，一经发现平台将取消其参与资格及奖金，严重者账号将被冻结。<br />7.平台保留对本次活动的最终解释权。</p>
		<a class="pop-btn" href="javascript:void();">确认</a>
	</div>

	<script type="text/javascript" src="<?php echo $base_url;?>js/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="<?php echo $base_url;?>js/jquery.animateNumber.min.js"></script>
<script>
var g_bonusTotal = 0;
var g_prize = 0;
// card - start
$(function(){
	var rabbit = $('#rabbit');
	var stepList = $('#stepList li');
	var boxList = $('#stepList .box');
	var cardList = $('#stepList .card');
	var globalprize ='';
	var betData = [
		{min:0,max:100,bouns:"0"},
		{min:100,max:500,bouns:"1"},
		{min:500,max:1200,bouns:"2"},
		{min:1200,max:1800,bouns:"4.5"},
		{min:1800,max:2700,bouns:"6.8"},
		{min:2700,max:4500,bouns:"10.1"},
		{min:4500,max:6100,bouns:"16.9"},
		{min:6100,max:9100,bouns:"22.9"},
		{min:9100,max:13500,bouns:"34.1"},
		{min:13500,max:20500,bouns:"50.6"},
		{min:20500,max:30700,bouns:"76.9"},
		{min:30700,max:46000,bouns:"115"},
		{min:46000,max:69000,bouns:"173"},
		{min:69000,max:103000,bouns:"259"},
		{min:103000,max:156000,bouns:"386"},
		{min:156000,max:233000,bouns:"5??"},
		{min:233000,max:350000,bouns:"8??"},
		{min:350000,max:525000,bouns:"1???"},
		{min:525000,max:790000,bouns:"1???"},
		{min:790000,max:1180000,bouns:"2???"},
		{min:1180000,max:2500000,bouns:"4???"},
		{min:2500000,max:Number.MAX_VALUE,bouns:"11888"},
	]
	//定额奖金宝箱
	for (var i = boxList.length - 1; i >= 0; i--){
		if(i > 13){
			boxList.eq(i).addClass('box-senior');
		}
	};

	var rollNum = function(n,obj){	
		var nL = String(n).length;
		obj.find('em').remove();
		var objNum = obj.find('em');
		var oL = objNum.length;
		for(var i=0;i<nL;i++){
			var num = String(n).charAt(i);
			if(oL<=i){
				obj.append('<em>'+num+'</em>');
			}
		}
	}

	var rabbitPosition = function(step){
		var w = rabbit.width();
		var h = rabbit.height();
		rabbit.show().appendTo(stepList.eq(step));
	}
	var pagePosition = function(ele){
		var t = ele.offset().top - 200;
		$('body,html').animate({scrollTop:t},1000);
	}

	var getLevel = function(amount){
		for(var i = 0; i < betData.length; i++){
			var item = betData[i];
			if(amount >= item.min && amount < item.max){
				return i;
			}
		}
	}

	//刮刮卡
	var scratcher = function(){
	    $('body').mozUserSelect = 'none';
	    $('body').webkitUserSelect = 'none';
	 	var scratcher = $('#scratcher');
	    //var img = new Image();
	    var canvas = document.querySelector('canvas');
	    $('#canvas').css({
			position: 'absolute',
			left: 0,
			top: 0,
			backgroundColor: 'transparent'
		})
	    //img.addEventListener('load', function(e) {
	        var ctx;
	        var w = scratcher.width(),
	            h = scratcher.height();
	        var mousedown = false;
	 
	        function layer(ctx) {
	            ctx.fillStyle = '#D1D1D1';
	            ctx.fillRect(0, 0, w, h);
	        }
	 
	        function eventDown(e){
	            e.preventDefault();
	            mousedown=true;
	        }
	 		
	        function eventUp(e){
	            e.preventDefault();
	            mousedown=false;
	            var data=ctx.getImageData(0,0,w,h).data;
	            console.log(data[1]+','+w+','+h);
	            for(var i=0,j=0;i< data.length;i+=4){
				    if(data[i] && data[i+1] && data[i+2] && data[i+3]){
				        j++;
				    }
				}
				if(j<=w*h*0.8){
					$('#popInfo').html('恭喜你刮中了<strong>'+globalprize+'</strong>元');
					$('#popInfo').css({marginTop: '0'});
					$('#popBtn').css({display: 'block'});
					cardList.eq(globalindex).find('strong').text(globalprize);
				}
	        }
	        function eventMove(e){
	            e.preventDefault();
	            var offsetX = $('canvas').offset().left,
	            	offsetY = $('canvas').offset().top;
	            if(mousedown) {
	                if(e.changedTouches){
	                    e=e.changedTouches[e.changedTouches.length-1];
	                }
	                
	                var x = (e.clientX + document.body.scrollLeft || e.pageX) - offsetX || 0,
	                    y = (e.clientY + document.body.scrollTop || e.pageY) - offsetY || 0;
	                with(ctx) {
	                    beginPath()
	                    arc(x, y, 10, 0, Math.PI * 2);
	                    fill();
	                }
	            }
	        }
	 
	        canvas.width=w;
	        canvas.height=h;
	        //canvas.style.backgroundImage='url('+img.src+')';
	        ctx=canvas.getContext('2d');
	        ctx.fillStyle='transparent';
	        ctx.fillRect(0, 0, w, h);
	        layer(ctx);
	 
	        ctx.globalCompositeOperation = 'destination-out';
	 
	        canvas.addEventListener('touchstart', eventDown);
	        canvas.addEventListener('touchend', eventUp);
	        canvas.addEventListener('touchmove', eventMove);
	        canvas.addEventListener('mousedown', eventDown);
	        canvas.addEventListener('mouseup', eventUp);
	        canvas.addEventListener('mousemove', eventMove);
	    //});
	    //img.src ='images/banner.jpg';
	};

	//页面初始化,从服务端获取投注金额,是否已刮奖
	$.ajax({type: 'POST',
		url:'<?php echo $base_url;?>guaguacard/getData',
		dataType:'json',
		data: { "come_from": "<?php echo $come_from;?>", "device": "<?php echo $device;?>", "sid": "<?php echo $sid;?>", "uuid": "<?php echo $uuid;?>", "userId": <?php echo $userId;?>},
		success:function(res){
			//alert(res);
			//判断请求是否成功
			if(Number(res['isSuccess']) == 1){
				//累计奖金
				g_bonusTotal = res['bonusTotal'];
				rollNum(g_bonusTotal,$('#bonusTotal'));
				//投注额
				var amount = res['amount'];
				//根据投注额判断当前等级
				var level = getLevel(amount);
				//是否刮奖
				var isScratch = res['scratch'];
				//历史中奖信息
				var hisPrize = res['hisPrize'];
				//点击宝箱之后中奖信息
				var prize = res['prize'];
				stepList.eq(level+1).append('<p class="betdiff-info">还需投注：<span id="betDiff">9999</span>元</p>');
				pagePosition(stepList.eq(level))
				$('#betTotal').text(amount).animateNumber({number:amount},2000);
				$('body').append('<div id="mask" class="mask"></div>');//加蒙版
				if(level > 0){
					rabbitPosition(level);
					$('.rabbit').eq(0).hide();
				}
				if(level < 21){
					$('#betDiff').text(betData[level+1].min-amount);
				}else{
					$('.step22').click(function(){
						if(!isScratch[isScratch.length-1]){
							$.ajax({type: 'POST',
							url:'<?php echo $base_url;?>event/doGuaguacardAct',
							dataType:'json',
							data: { "come_from": "<?php echo $come_from;?>", "device": "<?php echo $device;?>", "sid": "<?php echo $sid;?>", "uuid": "<?php echo $uuid;?>", "userId": <?php echo $userId;?>, "lv": 21},
							success:function(res){
									g_prize = res["prize"];
								}
							});
							$('#mask').delay(400).fadeIn(200);
							$('#popCup').show().removeClass('zoomOut').addClass('animation zoomIn');
							$(this).unbind('click');
						}
					});
				}
				
				//根据投注等级解锁宝箱
				for (var i = stepList.length; i >= 0; i--){
					if(i < level){
						boxList.eq(i).removeClass('box-lock').addClass('box-unlock');
						if(isScratch[i]){
							boxList.eq(i).hide();
							cardList.eq(i).show().find('strong').text(hisPrize[i]);
						}
					}
				};
				//点击未解锁宝箱
				$('.box-lock').click(function(){
					event.stopPropagation();
					var index = boxList.index(this);
					$('#amountInfo').appendTo($(this)).show();
					$('#bounsNum').text(betData[index+1].bouns);
					$('#betExpect').text(betData[index+1].min);
					if(index < 14){
						$('#bounsTit').text('最高奖金');
					}else{
						$('#bounsTit').text('定额奖金');
					}
				});
				
				//点击解锁宝箱
				$('.box-unlock').click(function(){
					var index = boxList.index(this);
					$(this).addClass('animation box-open').unbind('click');
					$('#mask').delay(400).fadeIn(200);
					$('#pop').show();//.removeClass('zoomOut').addClass('animation zoomIn');
					$(this).delay(800).fadeOut(200);
					setTimeout(function(){
						cardList.eq(index).show();
					},800);
					
					scratcher();
					$('#bounsScratcher').text(prize[index]);
					$('#popInfo').html('刮一刮 赢奖金');
					$('#popInfo').css({marginTop: '20px'});
					$('#popBtn').css({display: 'none'});
					globalindex = index;
					globalprize = prize[index];
					
					//从后台获取中奖数据
					$.ajax({type: 'POST',
						url:'<?php echo $base_url;?>event/doGuaguacardAct',
						dataType:'json',
						data: { "come_from": "<?php echo $come_from;?>", "device": "<?php echo $device;?>", "sid": "<?php echo $sid;?>", "uuid": "<?php echo $uuid;?>", "userId": <?php echo $userId;?>, "lv": index+1},
						success:function(res){
							g_prize = res["prize"];
							//g_prize = prize[index];
						}
					});
				});
			}else{
				//alert('请求失败，请重新刷新页面');
			}
		}
	});
	
	$('.pop-btn').click(function(){
		g_bonusTotal += g_prize * 1;
		g_prize = 0;
		rollNum(g_bonusTotal.toFixed(1),$('#bonusTotal'));
		$('.pop').hide();
		$('#mask').fadeOut();
	})

	$('.bg-moon').not('.box-lock').click(function(){
		$('#amountInfo').hide();
	})
	$('#btnNotice').click(function(){
		$('#popNotice').fadeIn();
		$('#mask').fadeIn();
	});

});
</script>
</body>
</html>

/*! nanoScrollerJS - v0.8.0 - (c) 2014 James Florentino; Licensed MIT */
!function(a,b,c){"use strict";var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;x={paneClass:"nano-pane",sliderClass:"nano-slider",contentClass:"nano-content",iOSNativeScrolling:!1,preventPageScrolling:!1,disableResize:!1,alwaysVisible:!1,flashDelay:1500,sliderMinHeight:20,sliderMaxHeight:null,documentContext:null,windowContext:null},s="scrollbar",r="scroll",k="mousedown",l="mousemove",n="mousewheel",m="mouseup",q="resize",h="drag",u="up",p="panedown",f="DOMMouseScroll",g="down",v="wheel",i="keydown",j="keyup",t="touchmove",d="Microsoft Internet Explorer"===b.navigator.appName&&/msie 7./i.test(b.navigator.appVersion)&&b.ActiveXObject,e=null,B=b.requestAnimationFrame,w=b.cancelAnimationFrame,D=c.createElement("div").style,F=function(){var a,b,c,d,e,f;for(d=["t","webkitT","MozT","msT","OT"],a=e=0,f=d.length;f>e;a=++e)if(c=d[a],b=d[a]+"ransform",b in D)return d[a].substr(0,d[a].length-1);return!1}(),E=function(a){return F===!1?!1:""===F?a:F+a.charAt(0).toUpperCase()+a.substr(1)},C=E("transform"),z=C!==!1,y=function(){var a,b,d;return a=c.createElement("div"),b=a.style,b.position="absolute",b.width="100px",b.height="100px",b.overflow=r,b.top="-9999px",c.body.appendChild(a),d=a.offsetWidth-a.clientWidth,c.body.removeChild(a),d},A=function(){var a,c,d;return c=b.navigator.userAgent,(a=/(?=.+Mac OS X)(?=.+Firefox)/.test(c))?(d=/Firefox\/\d{2}\./.exec(c),d&&(d=d[0].replace(/\D+/g,"")),a&&+d>23):!1},o=function(){function i(d,f){this.el=d,this.options=f,e||(e=y()),this.$el=a(this.el),this.doc=a(this.options.documentContext||c),this.win=a(this.options.windowContext||b),this.$content=this.$el.children("."+f.contentClass),this.$content.attr("tabindex",this.options.tabIndex||0),this.content=this.$content[0],this.previousPosition=0,this.options.iOSNativeScrolling&&null!=this.el.style.WebkitOverflowScrolling?this.nativeScrolling():this.generate(),this.createEvents(),this.addEvents(),this.reset()}return i.prototype.preventScrolling=function(a,b){if(this.isActive)if(a.type===f)(b===g&&a.originalEvent.detail>0||b===u&&a.originalEvent.detail<0)&&a.preventDefault();else if(a.type===n){if(!a.originalEvent||!a.originalEvent.wheelDelta)return;(b===g&&a.originalEvent.wheelDelta<0||b===u&&a.originalEvent.wheelDelta>0)&&a.preventDefault()}},i.prototype.nativeScrolling=function(){this.$content.css({WebkitOverflowScrolling:"touch"}),this.iOSNativeScrolling=!0,this.isActive=!0},i.prototype.updateScrollValues=function(){var a,b;a=this.content,this.maxScrollTop=a.scrollHeight-a.clientHeight,this.prevScrollTop=this.contentScrollTop||0,this.contentScrollTop=a.scrollTop,b=this.contentScrollTop>this.previousPosition?"down":this.contentScrollTop<this.previousPosition?"up":"same",this.previousPosition=this.contentScrollTop,"same"!==b&&this.$el.trigger("update",{position:this.contentScrollTop,maximum:this.maxScrollTop,direction:b}),this.iOSNativeScrolling||(this.maxSliderTop=this.paneHeight-this.sliderHeight,this.sliderTop=0===this.maxScrollTop?0:this.contentScrollTop*this.maxSliderTop/this.maxScrollTop)},i.prototype.setOnScrollStyles=function(){var a;z?(a={},a[C]="translate(0, "+this.sliderTop+"px)"):a={top:this.sliderTop},B?this.scrollRAF||(this.scrollRAF=B(function(b){return function(){b.scrollRAF=null,b.slider.css(a)}}(this))):this.slider.css(a)},i.prototype.createEvents=function(){this.events={down:function(a){return function(b){return a.isBeingDragged=!0,a.offsetY=b.pageY-a.slider.offset().top,a.pane.addClass("active"),a.doc.bind(l,a.events[h]).bind(m,a.events[u]),!1}}(this),drag:function(a){return function(b){return a.sliderY=b.pageY-a.$el.offset().top-a.offsetY,a.scroll(),a.contentScrollTop>=a.maxScrollTop&&a.prevScrollTop!==a.maxScrollTop?a.$el.trigger("scrollend"):0===a.contentScrollTop&&0!==a.prevScrollTop&&a.$el.trigger("scrolltop"),!1}}(this),up:function(a){return function(){return a.isBeingDragged=!1,a.pane.removeClass("active"),a.doc.unbind(l,a.events[h]).unbind(m,a.events[u]),!1}}(this),resize:function(a){return function(){a.reset()}}(this),panedown:function(a){return function(b){return a.sliderY=(b.offsetY||b.originalEvent.layerY)-.5*a.sliderHeight,a.scroll(),a.events.down(b),!1}}(this),scroll:function(a){return function(b){a.updateScrollValues(),a.isBeingDragged||(a.iOSNativeScrolling||(a.sliderY=a.sliderTop,a.setOnScrollStyles()),null!=b&&(a.contentScrollTop>=a.maxScrollTop?(a.options.preventPageScrolling&&a.preventScrolling(b,g),a.prevScrollTop!==a.maxScrollTop&&a.$el.trigger("scrollend")):0===a.contentScrollTop&&(a.options.preventPageScrolling&&a.preventScrolling(b,u),0!==a.prevScrollTop&&a.$el.trigger("scrolltop"))))}}(this),wheel:function(a){return function(b){var c;if(null!=b)return c=b.delta||b.wheelDelta||b.originalEvent&&b.originalEvent.wheelDelta||-b.detail||b.originalEvent&&-b.originalEvent.detail,c&&(a.sliderY+=-c/3),a.scroll(),!1}}(this)}},i.prototype.addEvents=function(){var a;this.removeEvents(),a=this.events,this.options.disableResize||this.win.bind(q,a[q]),this.iOSNativeScrolling||(this.slider.bind(k,a[g]),this.pane.bind(k,a[p]).bind(""+n+" "+f,a[v])),this.$content.bind(""+r+" "+n+" "+f+" "+t,a[r])},i.prototype.removeEvents=function(){var a;a=this.events,this.win.unbind(q,a[q]),this.iOSNativeScrolling||(this.slider.unbind(),this.pane.unbind()),this.$content.unbind(""+r+" "+n+" "+f+" "+t,a[r])},i.prototype.generate=function(){var a,c,d,f,g,h;return f=this.options,g=f.paneClass,h=f.sliderClass,a=f.contentClass,this.$el.find("."+g).length||this.$el.find("."+h).length||this.$el.append('<div class="'+g+'"><div class="'+h+'" /></div>'),this.pane=this.$el.children("."+g),this.slider=this.pane.find("."+h),0===e&&A()?(d=b.getComputedStyle(this.content,null).getPropertyValue("padding-right").replace(/\D+/g,""),c={right:-14,paddingRight:+d+14}):e&&(c={right:-e},this.$el.addClass("has-scrollbar")),null!=c&&this.$content.css(c),this},i.prototype.restore=function(){this.stopped=!1,this.iOSNativeScrolling||this.pane.show(),this.addEvents()},i.prototype.reset=function(){var a,b,c,f,g,h,i,j,k,l,m,n;return this.iOSNativeScrolling?void(this.contentHeight=this.content.scrollHeight):(this.$el.find("."+this.options.paneClass).length||this.generate().stop(),this.stopped&&this.restore(),a=this.content,f=a.style,g=f.overflowY,d&&this.$content.css({height:this.$content.height()}),b=a.scrollHeight+e,l=parseInt(this.$el.css("max-height"),10),l>0&&(this.$el.height(""),this.$el.height(a.scrollHeight>l?l:a.scrollHeight)),i=this.pane.outerHeight(!1),k=parseInt(this.pane.css("top"),10),h=parseInt(this.pane.css("bottom"),10),j=i+k+h,n=Math.round(j/b*j),n<this.options.sliderMinHeight?n=this.options.sliderMinHeight:null!=this.options.sliderMaxHeight&&n>this.options.sliderMaxHeight&&(n=this.options.sliderMaxHeight),g===r&&f.overflowX!==r&&(n+=e),this.maxSliderTop=j-n,this.contentHeight=b,this.paneHeight=i,this.paneOuterHeight=j,this.sliderHeight=n,this.slider.height(n),this.events.scroll(),this.pane.show(),this.isActive=!0,a.scrollHeight===a.clientHeight||this.pane.outerHeight(!0)>=a.scrollHeight&&g!==r?(this.pane.hide(),this.isActive=!1):this.el.clientHeight===a.scrollHeight&&g===r?this.slider.hide():this.slider.show(),this.pane.css({opacity:this.options.alwaysVisible?1:"",visibility:this.options.alwaysVisible?"visible":""}),c=this.$content.css("position"),("static"===c||"relative"===c)&&(m=parseInt(this.$content.css("right"),10),m&&this.$content.css({right:"",marginRight:m})),this)},i.prototype.scroll=function(){return this.isActive?(this.sliderY=Math.max(0,this.sliderY),this.sliderY=Math.min(this.maxSliderTop,this.sliderY),this.$content.scrollTop((this.paneHeight-this.contentHeight+e)*this.sliderY/this.maxSliderTop*-1),this.iOSNativeScrolling||(this.updateScrollValues(),this.setOnScrollStyles()),this):void 0},i.prototype.scrollBottom=function(a){return this.isActive?(this.$content.scrollTop(this.contentHeight-this.$content.height()-a).trigger(n),this.stop().restore(),this):void 0},i.prototype.scrollTop=function(a){return this.isActive?(this.$content.scrollTop(+a).trigger(n),this.stop().restore(),this):void 0},i.prototype.scrollTo=function(a){return this.isActive?(this.scrollTop(this.$el.find(a).get(0).offsetTop),this):void 0},i.prototype.stop=function(){return w&&this.scrollRAF&&(w(this.scrollRAF),this.scrollRAF=null),this.stopped=!0,this.removeEvents(),this.iOSNativeScrolling||this.pane.hide(),this},i.prototype.destroy=function(){return this.stopped||this.stop(),!this.iOSNativeScrolling&&this.pane.length&&this.pane.remove(),d&&this.$content.height(""),this.$content.removeAttr("tabindex"),this.$el.hasClass("has-scrollbar")&&(this.$el.removeClass("has-scrollbar"),this.$content.css({right:""})),this},i.prototype.flash=function(){return!this.iOSNativeScrolling&&this.isActive?(this.reset(),this.pane.addClass("flashed"),setTimeout(function(a){return function(){a.pane.removeClass("flashed")}}(this),this.options.flashDelay),this):void 0},i}(),a.fn.nanoScroller=function(b){return this.each(function(){var c,d;if((d=this.nanoscroller)||(c=a.extend({},x,b),this.nanoscroller=d=new o(this,c)),b&&"object"==typeof b){if(a.extend(d.options,b),null!=b.scrollBottom)return d.scrollBottom(b.scrollBottom);if(null!=b.scrollTop)return d.scrollTop(b.scrollTop);if(b.scrollTo)return d.scrollTo(b.scrollTo);if("bottom"===b.scroll)return d.scrollBottom(0);if("top"===b.scroll)return d.scrollTop(0);if(b.scroll&&b.scroll instanceof a)return d.scrollTo(b.scroll);if(b.stop)return d.stop();if(b.destroy)return d.destroy();if(b.flash)return d.flash()}return d.reset()})},a.fn.nanoScroller.Constructor=o}(jQuery,window,document);

// avchat.js
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.AVChatClient=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){XMLHttpRequest=typeof XMLHttpRequest==="undefined"?require("xmlhttprequest").XMLHttpRequest:XMLHttpRequest;WebSocket=typeof WebSocket==="undefined"||WebSocket==null?require("ws"):WebSocket;var Promise=require("es6-promise").Promise;var EventEmitter=require("events").EventEmitter;module.exports=AVChatClient;function AVChatClient(settings){if(this instanceof AVChatClient==false){return new AVChatClient(settings)}var _emitter,_settings,_waitCommands,server,ws,keepAliveTimeout;var cmdMap={direct:"ack",sessionopen:"sessionopened",sessionadd:"sessionadded",sessionquery:"sessionquery-result",roomjoin:"roomjoined",roominvite:"roominvited",roomleave:"roomleft",roomkick:"roomkicked"};var timers=[];function auth(peerId,watchingPeerIds){return Promise.resolve({watchingPeerIds:watchingPeerIds||[]})}function groupAuth(peerId,groupId,action,groupPeerIds){return Promise.resolve({groupPeerIds:groupPeerIds||[]})}function initialize(settings){if(!settings)throw new Error("settings");if(!settings.appId)throw new Error("settings.appId");if(!settings.peerId)throw new Error("settings.peerId");if(settings.auth&&typeof settings.auth!="function"){throw new Error("sesstings.auth")}if(settings.groupAuth&&typeof settings.groupAuth!="function"){throw new Error("sesstings.groupAuth")}_settings=settings||{};_settings.auth=settings.auth||auth;_settings.groupAuth=settings.groupAuth||groupAuth;_settings.watchingPeerIds=settings.watchingPeerIds||[];_settings.sp=settings.sp;_settings.server=settings.server;_waitCommands=[];_emitter=new EventEmitter;keepAliveTimeout=6e4}initialize(settings);function _getServerInfo(appId,secure){var protocol="http://";if(typeof window!="undefined"&&window.location&&window.location.protocol=="https:"){protocol="https://"}var url=protocol+"router-g0-push.avoscloud.com/v1/route?appId="+appId;if(_settings.server&&_settings.server=="us"){url=protocol+"router-a0-push.avoscloud.com/v1/route?appId="+appId}if(secure){url+="&secure=1"}return get(url)}function _connect(){if(server&&new Date<server.expires){return new Promise(function(resolve,reject){ws=new WebSocket(server.server);_timeout("connectopen",function(){reject()});ws.onopen=function(){if(timers.length>0){clearTimeout(timers.shift()[1])}resolve(server)};ws.onclose=function(e){doClose();_emitter.emit("close",e)};ws.onmessage=function(message){var data=JSON.parse(message.data);var cmd=data.op?data.cmd+data.op:data.cmd;if(!cmd){cmd="{}"}if(_waitCommands.length>0&&_waitCommands[0][0]===cmd){_waitCommands.shift()[1](data)}if(timers.length>0&&timers[0][0]==cmd){clearTimeout(timers.shift()[1])}if(data.cmd=="session"){if(data.op=="opened"||data.op=="added"){_emitter.emit("online",data.onlineSessionPeerIds)}}else if(data.cmd=="presence"){if(data.status=="on"){_emitter.emit("online",data.sessionPeerIds)}else if(data.status=="off"){_emitter.emit("offline",data.sessionPeerIds)}}else if(data.cmd=="direct"){_emitter.emit("message",data);var msg={cmd:"ack",peerId:_settings.peerId,appId:_settings.appId,ids:[].concat(data.id)};var s=JSON.stringify(msg);ws.send(s)}else if(data.cmd=="room"){if(data.op=="members-joined"){_emitter.emit("membersJoined",data)}else if(data.op=="members-left"){_emitter.emit("membersLeft",data)}else if(data.op=="joined"){_emitter.emit("joined",data)}else if(data.op=="left"){_emitter.emit("left",data)}}}})}else{return _getServerInfo(_settings.appId,_settings.secure).then(function(result){server=result;server.expires=Date.now()+server.ttl*1e3;return _connect()})}}function _openSession(){return _settings.auth(_settings.peerId,_settings.watchingPeerIds,_settings.sp).then(function(data){_settings.watchingPeerIds=data.watchingPeerIds;return doCommand("session","open",{sessionPeerIds:data.watchingPeerIds,s:data.s,t:data.t,n:data.n,sp:data.sp})})}function _timeout(name,reject){timers.push([name,setTimeout(function(){if(reject){reject(name+"timeout")}doClose()},1e4)])}function _keepAlive(){clearTimeout(_keepAlive.handle);_keepAlive.handle=setTimeout(function(){if(ws.readyState==1){ws.send("{}");_timeout("{}");_keepAlive()}},keepAliveTimeout)}function doClose(){ws.close();clearTimeout(_keepAlive.handle);timers.forEach(function(v,i){clearTimeout(v[1])});_waitCommands.forEach(function(v){v[2]()});timers=[];_waitCommands=[]}function doCommand(cmd,op,props){_keepAlive();var msg={cmd:cmd,peerId:_settings.peerId,appId:_settings.appId};if(op){msg.op=op}if(props){for(k in props){msg[k]=props[k]}}if(!ws){return Promise.reject()}if(ws.readyState!=1){return Promise.reject(ws.readyState)}ws.send(JSON.stringify(msg));var c=typeof op=="undefined"?cmd:cmd+op;if(cmd=="direct"&&props.transient==true||["sessionremove","sessionclose"].indexOf(c)>-1){return Promise.resolve()}else{return new Promise(function(resolve,reject){_waitCommands.push([cmdMap[c]||c,resolve,reject]);_timeout(cmdMap[c]||c,reject)})}}this.open=function(){if(ws&&ws.readyState==0){return Promise.reject(0)}if(ws&&ws.readyState==1){return Promise.resolve()}timers.forEach(function(v,i){clearTimeout(v[1])});timers=[];return _connect().then(function(){return _openSession()})};this.close=function(){doCommand("session","close");doClose();return Promise.resolve()};this.send=function(msg,to,transient){var obj={msg:msg,toPeerIds:[].concat(to)};if(typeof transient!="undefined"&&transient==true){obj.transient=transient}return doCommand("direct",undefined,obj)};this.on=function(name,func){_emitter.on(name,func)};this.watch=function(peers){return _settings.auth(_settings.peerId,[].concat(peers)).then(function(data){var watch=[].concat(data.watchingPeerIds);watch.forEach(function(v,k){if(_settings.watchingPeerIds.indexOf(v)==-1){_settings.watchingPeerIds.push(v)}});return doCommand("session","add",{sessionPeerIds:[].concat(data.watchingPeerIds),s:data.s,t:data.t,n:data.n})})};this.unwatch=function(peers){peers.forEach(function(v,k){if(_settings.watchingPeerIds.indexOf(v)>-1){_settings.watchingPeerIds.splice(_settings.watchingPeerIds.indexOf(v),1)}});return doCommand("session","remove",{sessionPeerIds:[].concat(peers)})};this.getStatus=function(peers){return doCommand("session","query",{sessionPeerIds:[].concat(peers)})};this.joinGroup=function(groupId){return _settings.groupAuth(_settings.peerId,groupId,"join",[]).then(function(data){return doCommand("room","join",{roomId:groupId,s:data.s,t:data.t,n:data.n})})};this.sendToGroup=function(msg,groupId,transient){var obj={msg:msg,roomId:groupId};if(typeof transient!="undefined"&&transient==true){obj.transient=transient}return doCommand("direct",undefined,obj)};this.inviteToGroup=function(groupId,groupPeerIds){return _settings.groupAuth(_settings.peerId,groupId,"invite",[].concat(groupPeerIds)).then(function(data){return doCommand("room","invite",{roomId:groupId,roomPeerIds:[].concat(data.groupPeerIds),s:data.s,t:data.t,n:data.n})})};this.kickFromGroup=function(groupId,groupPeerIds){return _settings.groupAuth(_settings.peerId,groupId,"kick",[].concat(groupPeerIds)).then(function(data){return doCommand("room","kick",{roomId:groupId,roomPeerIds:[].concat(groupPeerIds),s:data.s,t:data.t,n:data.n})})};this.leaveGroup=function(groupId){return doCommand("room","leave",{roomId:groupId})}}function get(url){if(typeof jQuery!=="undefined"){return Promise.resolve(jQuery.getJSON.call(jQuery,url+="&cb=?"))}else{return new Promise(function(resolve,reject){var req=new XMLHttpRequest;req.open("GET",url);req.onload=function(){if(req.status==200){resolve(JSON.parse(req.responseText))}else{reject(Error(req.statusText))}};req.onerror=function(){reject(Error("Network Error"))};req.send()})}}},{"es6-promise":2,events:12,ws:undefined,xmlhttprequest:undefined}],2:[function(require,module,exports){"use strict";var Promise=require("./promise/promise").Promise;var polyfill=require("./promise/polyfill").polyfill;exports.Promise=Promise;exports.polyfill=polyfill},{"./promise/polyfill":6,"./promise/promise":7}],3:[function(require,module,exports){"use strict";var isArray=require("./utils").isArray;var isFunction=require("./utils").isFunction;function all(promises){var Promise=this;if(!isArray(promises)){throw new TypeError("You must pass an array to all.")}return new Promise(function(resolve,reject){var results=[],remaining=promises.length,promise;if(remaining===0){resolve([])}function resolver(index){return function(value){resolveAll(index,value)}}function resolveAll(index,value){results[index]=value;if(--remaining===0){resolve(results)}}for(var i=0;i<promises.length;i++){promise=promises[i];if(promise&&isFunction(promise.then)){promise.then(resolver(i),reject)}else{resolveAll(i,promise)}}})}exports.all=all},{"./utils":11}],4:[function(require,module,exports){(function(process,global){"use strict";var browserGlobal=typeof window!=="undefined"?window:{};var BrowserMutationObserver=browserGlobal.MutationObserver||browserGlobal.WebKitMutationObserver;var local=typeof global!=="undefined"?global:this===undefined?window:this;function useNextTick(){return function(){process.nextTick(flush)}}function useMutationObserver(){var iterations=0;var observer=new BrowserMutationObserver(flush);var node=document.createTextNode("");observer.observe(node,{characterData:true});return function(){node.data=iterations=++iterations%2}}function useSetTimeout(){return function(){local.setTimeout(flush,1)}}var queue=[];function flush(){for(var i=0;i<queue.length;i++){var tuple=queue[i];var callback=tuple[0],arg=tuple[1];callback(arg)}queue=[]}var scheduleFlush;if(typeof process!=="undefined"&&{}.toString.call(process)==="[object process]"){scheduleFlush=useNextTick()}else if(BrowserMutationObserver){scheduleFlush=useMutationObserver()}else{scheduleFlush=useSetTimeout()}function asap(callback,arg){var length=queue.push([callback,arg]);if(length===1){scheduleFlush()}}exports.asap=asap}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{_process:13}],5:[function(require,module,exports){"use strict";var config={instrument:false};function configure(name,value){if(arguments.length===2){config[name]=value}else{return config[name]}}exports.config=config;exports.configure=configure},{}],6:[function(require,module,exports){(function(global){"use strict";var RSVPPromise=require("./promise").Promise;var isFunction=require("./utils").isFunction;function polyfill(){var local;if(typeof global!=="undefined"){local=global}else if(typeof window!=="undefined"&&window.document){local=window}else{local=self}var es6PromiseSupport="Promise"in local&&"resolve"in local.Promise&&"reject"in local.Promise&&"all"in local.Promise&&"race"in local.Promise&&function(){var resolve;new local.Promise(function(r){resolve=r});return isFunction(resolve)}();if(!es6PromiseSupport){local.Promise=RSVPPromise}}exports.polyfill=polyfill}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./promise":7,"./utils":11}],7:[function(require,module,exports){"use strict";var config=require("./config").config;var configure=require("./config").configure;var objectOrFunction=require("./utils").objectOrFunction;var isFunction=require("./utils").isFunction;var now=require("./utils").now;var all=require("./all").all;var race=require("./race").race;var staticResolve=require("./resolve").resolve;var staticReject=require("./reject").reject;var asap=require("./asap").asap;var counter=0;config.async=asap;function Promise(resolver){if(!isFunction(resolver)){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}if(!(this instanceof Promise)){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}this._subscribers=[];invokeResolver(resolver,this)}function invokeResolver(resolver,promise){function resolvePromise(value){resolve(promise,value)}function rejectPromise(reason){reject(promise,reason)}try{resolver(resolvePromise,rejectPromise)}catch(e){rejectPromise(e)}}function invokeCallback(settled,promise,callback,detail){var hasCallback=isFunction(callback),value,error,succeeded,failed;if(hasCallback){try{value=callback(detail);succeeded=true}catch(e){failed=true;error=e}}else{value=detail;succeeded=true}if(handleThenable(promise,value)){return}else if(hasCallback&&succeeded){resolve(promise,value)}else if(failed){reject(promise,error)}else if(settled===FULFILLED){resolve(promise,value)}else if(settled===REJECTED){reject(promise,value)}}var PENDING=void 0;var SEALED=0;var FULFILLED=1;var REJECTED=2;function subscribe(parent,child,onFulfillment,onRejection){var subscribers=parent._subscribers;var length=subscribers.length;subscribers[length]=child;subscribers[length+FULFILLED]=onFulfillment;subscribers[length+REJECTED]=onRejection}function publish(promise,settled){var child,callback,subscribers=promise._subscribers,detail=promise._detail;for(var i=0;i<subscribers.length;i+=3){child=subscribers[i];callback=subscribers[i+settled];invokeCallback(settled,child,callback,detail)}promise._subscribers=null}Promise.prototype={constructor:Promise,_state:undefined,_detail:undefined,_subscribers:undefined,then:function(onFulfillment,onRejection){var promise=this;var thenPromise=new this.constructor(function(){});if(this._state){var callbacks=arguments;config.async(function invokePromiseCallback(){invokeCallback(promise._state,thenPromise,callbacks[promise._state-1],promise._detail)})}else{subscribe(this,thenPromise,onFulfillment,onRejection)}return thenPromise},"catch":function(onRejection){return this.then(null,onRejection)}};Promise.all=all;Promise.race=race;Promise.resolve=staticResolve;Promise.reject=staticReject;function handleThenable(promise,value){var then=null,resolved;try{if(promise===value){throw new TypeError("A promises callback cannot return that same promise.")}if(objectOrFunction(value)){then=value.then;if(isFunction(then)){then.call(value,function(val){if(resolved){return true}resolved=true;if(value!==val){resolve(promise,val)}else{fulfill(promise,val)}},function(val){if(resolved){return true}resolved=true;reject(promise,val)});return true}}}catch(error){if(resolved){return true}reject(promise,error);return true}return false}function resolve(promise,value){if(promise===value){fulfill(promise,value)}else if(!handleThenable(promise,value)){fulfill(promise,value)}}function fulfill(promise,value){if(promise._state!==PENDING){return}promise._state=SEALED;promise._detail=value;config.async(publishFulfillment,promise)}function reject(promise,reason){if(promise._state!==PENDING){return}promise._state=SEALED;promise._detail=reason;config.async(publishRejection,promise)}function publishFulfillment(promise){publish(promise,promise._state=FULFILLED)}function publishRejection(promise){publish(promise,promise._state=REJECTED)}exports.Promise=Promise},{"./all":3,"./asap":4,"./config":5,"./race":8,"./reject":9,"./resolve":10,"./utils":11}],8:[function(require,module,exports){"use strict";var isArray=require("./utils").isArray;function race(promises){var Promise=this;if(!isArray(promises)){throw new TypeError("You must pass an array to race.")}return new Promise(function(resolve,reject){var results=[],promise;for(var i=0;i<promises.length;i++){promise=promises[i];if(promise&&typeof promise.then==="function"){promise.then(resolve,reject)}else{resolve(promise)}}})}exports.race=race},{"./utils":11}],9:[function(require,module,exports){"use strict";function reject(reason){var Promise=this;return new Promise(function(resolve,reject){reject(reason)})}exports.reject=reject},{}],10:[function(require,module,exports){"use strict";function resolve(value){if(value&&typeof value==="object"&&value.constructor===this){return value}var Promise=this;return new Promise(function(resolve){resolve(value)})}exports.resolve=resolve},{}],11:[function(require,module,exports){"use strict";function objectOrFunction(x){return isFunction(x)||typeof x==="object"&&x!==null}function isFunction(x){return typeof x==="function"}function isArray(x){return Object.prototype.toString.call(x)==="[object Array]"}var now=Date.now||function(){return(new Date).getTime()};exports.objectOrFunction=objectOrFunction;exports.isFunction=isFunction;exports.isArray=isArray;exports.now=now},{}],12:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}throw TypeError('Uncaught, unspecified "error" event.')}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}}else if(isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){var m;if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else{while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],13:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canMutationObserver=typeof window!=="undefined"&&window.MutationObserver;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}var queue=[];if(canMutationObserver){var hiddenDiv=document.createElement("div");var observer=new MutationObserver(function(){var queueList=queue.slice();queue.length=0;queueList.forEach(function(fn){fn()})});observer.observe(hiddenDiv,{attributes:true});return function nextTick(fn){if(!queue.length){hiddenDiv.setAttribute("yes","no")}queue.push(fn)}}if(canPost){window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}]},{},[1])(1)});

// EventEmitter.js
(function(){"use strict";function t(){}function i(t,n){for(var e=t.length;e--;)if(t[e].listener===n)return e;return-1}function n(e){return function(){return this[e].apply(this,arguments)}}var e=t.prototype,r=this,s=r.EventEmitter;e.getListeners=function(n){var r,e,t=this._getEvents();if(n instanceof RegExp){r={};for(e in t)t.hasOwnProperty(e)&&n.test(e)&&(r[e]=t[e])}else r=t[n]||(t[n]=[]);return r},e.flattenListeners=function(t){var e,n=[];for(e=0;e<t.length;e+=1)n.push(t[e].listener);return n},e.getListenersAsObject=function(n){var e,t=this.getListeners(n);return t instanceof Array&&(e={},e[n]=t),e||t},e.addListener=function(r,e){var t,n=this.getListenersAsObject(r),s="object"==typeof e;for(t in n)n.hasOwnProperty(t)&&-1===i(n[t],e)&&n[t].push(s?e:{listener:e,once:!1});return this},e.on=n("addListener"),e.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},e.once=n("addOnceListener"),e.defineEvent=function(e){return this.getListeners(e),this},e.defineEvents=function(t){for(var e=0;e<t.length;e+=1)this.defineEvent(t[e]);return this},e.removeListener=function(r,s){var n,e,t=this.getListenersAsObject(r);for(e in t)t.hasOwnProperty(e)&&(n=i(t[e],s),-1!==n&&t[e].splice(n,1));return this},e.off=n("removeListener"),e.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},e.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},e.manipulateListeners=function(r,t,i){var e,n,s=r?this.removeListener:this.addListener,o=r?this.removeListeners:this.addListeners;if("object"!=typeof t||t instanceof RegExp)for(e=i.length;e--;)s.call(this,t,i[e]);else for(e in t)t.hasOwnProperty(e)&&(n=t[e])&&("function"==typeof n?s.call(this,e,n):o.call(this,e,n));return this},e.removeEvent=function(e){var t,r=typeof e,n=this._getEvents();if("string"===r)delete n[e];else if(e instanceof RegExp)for(t in n)n.hasOwnProperty(t)&&e.test(t)&&delete n[t];else delete this._events;return this},e.removeAllListeners=n("removeEvent"),e.emitEvent=function(r,o){var e,i,t,s,n=this.getListenersAsObject(r);for(t in n)if(n.hasOwnProperty(t))for(i=n[t].length;i--;)e=n[t][i],e.once===!0&&this.removeListener(r,e.listener),s=e.listener.apply(this,o||[]),s===this._getOnceReturnValue()&&this.removeListener(r,e.listener);return this},e.trigger=n("emitEvent"),e.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},e.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},e._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},e._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return r.EventEmitter=s,t},"function"==typeof define&&define.amd?define(function(){return t}):"object"==typeof module&&module.exports?module.exports=t:r.EventEmitter=t}).call(this);

// green.js
window.Green=function(c){var b={noConflict:a};return b;function a(){if(window.Green===b){window.Green=c}return b}}(window.Green);Green._View=function(d,a,b,c){}(window,document,Green,EventEmitter);Green._EventHandler=function(d,a,b,c){return new c()}(window,document,Green,EventEmitter);Green._Utils=function(h,a,d){function e(j,i){return((i.getDate()!=j.getDate())||(i.getFullYear()!=j.getFullYear())||(i.getMonth()!=j.getMonth()))}function b(i){return this.isDifferentDay(i,new Date())?(parseInt(i.getMonth()+1)+"-"+i.getDate()+" "+i.toTimeString().substr(0,5)):i.toTimeString().substr(0,5)}function g(j,m){var k=/<%([^%>]+)?%>/g,i=/(^( )?(if|for|else|switch|case|break|{|}))(.*)?/g,l="var r=[];\n",o=0;var n=function(p,q){q?(l+=p.match(i)?p+"\n":"r.push("+p+");\n"):(l+=p!=""?'r.push("'+p.replace(/"/g,'\\"')+'");\n':"");return n};while(match=k.exec(html)){n(html.slice(o,match.index))(match[1],true);o=match.index+match[0].length}n(html.substr(o,html.length-o));l+='return r.join("");';return new Function(l.replace(/[\r\t\n]/g,"")).apply(options)}function c(r,q){var k=r,q=q||70,m=(function(){var t={},s=8,u="width fontSize fontFamily lineHeight wordWrap wordBreak whiteSpace letterSpacing".split(" ");while(s--){t[u[s]]=k.css(u[s])}return $.extend(t,{position:"absolute",left:-9999,top:0})})(),i=k.clone().css(m).attr({id:"",name:"",tabIndex:-1}),n,l,j=k.height(),o=$([k[0],i[0]]),p=function(){l=k.val();i.val(l).height(1).scrollTop(9999);n=Math.min(Math.max(j,i.scrollTop()),q);o.height(n)};k.after(i).bind("focus input change propertychange",p)}function f(i){if(!d.debug){return}$(".log").append("<p>"+this.tranTime(new Date())+"："+i+"</p>")}return{isDifferentDay:e,tranTime:b,template:g,freeTextarea:c,log:f}}(window,document,Green);Green._StatusView=function(c,a,b,e){var d={};d.commit=function(){var f='<div class="status-view"></div>';this.dom=$(f);return this.dom};d.msg=function(f){this.dom.html(f).show()};d.hide=function(){this.dom.hide()};return d}(window,document,Green,EventEmitter);Green._RosterView=function(f,b,c,g,d){function a(h){this.roster=h}a.prototype.commit=function e(){var h='<div class="roster cf" peer="'+this.roster.id+'">'+'<span class="unread-dot" style="display:none;"></span>'+'<span class="unread-dots" style="display:none"></span>'+'<span class="chat-status '+this.roster.onlineStatus+'"></span>'+'<div class="avatar-wrap">'+'<img class="avatar" src="'+this.roster.image+'">'+"</div>"+'<div class="info">'+'<div class="nick-name">'+'<div class="name" style="">'+this.roster.name+"</div>"+"</div>"+"</div>"+"</div>";this.dom=$(h);this.dom.click($.proxy(function(){d.trigger("rosterClick",[this])},this));return this.dom};a.prototype.updateUnread=function(h){var i=this.dom.find(".unread-dot");this.roster.unreadCount=h;if(h==0){i.hide()}else{i.html(h).show()}};a.prototype.updateOnlineStatus=function(h){this.roster.onlineStatus=h;this.dom.find(".chat-status").removeClass().addClass("chat-status "+h)};return a}(window,document,Green,Green._Utils,Green._EventHandler);Green._RosterListView=function(f,b,d,g,e,a){var c={};c.commit=function(i){var h='<div class="contacts">'+'<div class="title"><i class="icon-user"></i>&nbsp;<b>聊天联系人</b></div>'+'<div class="roster-list"><div class="nano"><div class="active nano-content"></div></div></div>'+'<div class="bottom cf"><div class="online-status"><div class="me-status"><span class="chat-status online"></span><div class="status-text">在线</div></div></div><div class="toggle-btn"><div class="backward" title="展开">&nbsp;<i class="icon-step-backward"></i></div><div class="forward" title="收缩"><i class="icon-step-forward"></i>&nbsp;<b>收缩</b></div></div></div>'+"</div>";this.dom=$(h);this.rosterViews={};$.each(i,function(l,k){var j=new a(k);c.rosterViews[l]=j;c.dom.find(".active").append(j.commit())});this.dom.find(".title, .toggle-btn").click(function(){e.trigger("rosterListViewToggle",[!c.dom.hasClass("contacts-minus")])});return this.dom};c.init=function(){var m=40;var k=30;var l=62;var h=$(f).height()-l;var j=$(f).height()-l-m-k;var i=c.dom.find(".nano");i.css("height",j+"px");i.nanoScroller();this.height=h;this.innerHeight=j};c.get=function(h){return this.rosterViews[h]};c.toggle=function(h){if(h){this.dom.addClass("contacts-minus")}else{this.dom.removeClass("contacts-minus")}};c.prepend=function(h){this.get(h).dom.prependTo(this.dom.find(".active"))};c.hide=function(){this.dom.hide()};c.show=function(){this.dom.show()};return c}(window,document,Green,Green._Utils,Green._EventHandler,Green._RosterView);Green._ConverseView=function(e,b,c,g,d){function a(h){this.roster=h}a.prototype.commit=function(){var h='<div class="nano" peer="'+this.roster.id+'">'+'<div class="nano-content messages">'+'<div class="no-more-history"><i class="icon-ban-circle"></i><b>无更多历史消息</b></div>'+'<div class="loadmore"><div class="linit"><i class="icon-time"></i><b>更多历史消息</b></div><div class="lloading"><img src="./image/loading-cir.gif">历史消息加载中...</div></div>'+"</div>"+"</div>";this.dom=$(h);f.call(this);return this.dom};function f(){var i=this.dom.find(".loadmore");i.click($.proxy(function(){if(i.hasClass("loadmore-loading")){return false}i.addClass("loadmore-loading");var j={convid:[c.me.id,this.roster.id],timestamp:this.lastMessage.timestamp,limit:30};d.trigger("getHistory",[j,this])},this));this.lastMessage={};var h=this.roster.unreadMessages;if(h.length==0){this.lastMessage["timestamp"]=new Date().getTime();i.trigger("click")}else{this.lastMessage=h[0];this.renderMessage(h,"receive");this.roster.unreadMessages=[]}}a.prototype.renderMessage=function(l,n){if(!(l instanceof Array)){l=[l]}var q="";var k;var r;var h;for(var m=0,o=l.length;m<o;m++){k=g.tranTime(new Date(l[m].timestamp));if(l[m].from==c.me.id){r={"pic":c.me.image,"name":c.me.name,"sign":"me","message":l[m].data,"date":k}}else{r={"pic":c.rosters[l[m].from].image,"name":c.rosters[l[m].from].name,"sign":"you","message":l[m].data,"date":k}}h="";if(n=="send"){h='<div class="send-status"><img src="./image/send-loading.gif"><b>发送失败</b></div>'}q+='<div class="cf chat-item '+r.sign+'">'+'<div class="time">'+r.name+"："+r.date+" </div>"+'<div class="chat-item-content cf">'+'<img class="avatar" src="'+r.pic+'" title="'+r.name+'" alt="'+r.name+'">'+'<div class="cloud cloud-text">'+'<div class="cloud-pannel">'+'<div class="cloud-body">'+'<div class="cloud-content">'+'<pre style="white-space:pre-wrap;*white-space:pre;*word-wrap:break-word;">'+r.message+"</pre>"+"</div>"+"</div>"+'<div class="cloud-arrow"></div>'+"</div>"+"</div>"+h+"</div>"+"</div>"}var j=$(q);if(n=="history"){var p=this.getPosition();this.dom.find(".loadmore").after(j);this.scroll();this.adjustPosition(p)}if(n=="receive"||n=="send"){this.dom.find(".messages").append(j);this.scroll();this.scrollDown()}if(n=="notCurrent"){this.dom.find(".messages").append(j);this.scroll()}return j};a.prototype.showLoadmore=function(){this.dom.find(".loadmore").removeClass("loadmore-loading").show().find("b").html("更多历史消息")};a.prototype.showHistoryFailed=function(){this.dom.find(".loadmore").removeClass("loadmore-loading").show().find("b").html("加载历史信息失败 点击重试")};a.prototype.showNoHistory=function(){this.dom.find(".loadmore").hide();this.dom.find(".no-more-history").show()};a.prototype.scrollDown=function(){var h=this.dom.find(".messages");h.stop().animate({scrollTop:h[0].scrollHeight})};a.prototype.adjustPosition=function(h){this.dom.nanoScroller({scrollTop:this.getPosition()-h})};a.prototype.getPosition=function(){return this.dom.find(".messages")[0].scrollHeight};a.prototype.scroll=function(){this.dom.nanoScroller({preventPageScrolling:true,alwaysVisible:true})};a.prototype.destroy=function(){this.dom.nanoScroller({destroy:true});this.dom.remove();delete this};return a}(window,document,Green,Green._Utils,Green._EventHandler);Green._ConverseListView=function(e,b,c,f,d,a){var g={};g.commit=function(){var h='<div class="convers"></div>';this.dom=$(h);this.converseListViews={};return this.dom};g.add=function(j){var i=this.get(j.id);if(i){return i}var h=new a(j);this.converseListViews[j.id]=h;this.dom.append(h.commit());this.currentView=h;return h};g.get=function(h){return this.converseListViews[h]};g.front=function(h){this.get(h).dom.css("zIndex",100).siblings().css("zIndex",99)};g.show=function(){this.dom.show()};g.hide=function(){this.dom.hide()};g.remove=function(h){this.get(h).destroy();delete this.converseListViews[h]};g.removeAll=function(){$.each(this.converseListViews,function(i,h){h.destroy()});this.converseListViews={};this.currentView=null};return g}(window,document,Green,Green._Utils,Green._EventHandler,Green._ConverseView);Green._ChatWithView=function(e,a,b,g,c){function h(i){this.roster=i}h.prototype.commit=function d(){var i='<div class="chat-with cf" peer="'+this.roster.id+'">'+'<div class="list-head-status"><span class="chat-status '+this.roster.onlineStatus+'"></span></div>'+'<div class="chat-with-name">'+this.roster.name+"</div>"+'<a href="javascript:void(0);" class="chat-close"><i class="icon-remove"></i></a>'+'<a href="javascript:void(0);" class="msg-unread"><i class="icon-volume-down"></i></a>'+"</div>";this.dom=$(i);f.call(this);return this.dom};function f(){this.dom.click($.proxy(function(){c.trigger("chatWithClick",[this])},this));this.dom.find(".icon-remove").click($.proxy(function(){c.trigger("chatWithRemove",[this])},this))}h.prototype.updateUnread=function(i){var j=this.dom.find(".msg-unread");this.roster.unreadCount=i;if(i==0){j.hide()}else{j.show()}};h.prototype.updateOnlineStatus=function(i){this.roster.onlineStatus=i;this.dom.find(".chat-status").removeClass().addClass("chat-status "+i)};h.prototype.active=function(){this.dom.addClass("active").siblings().removeClass("active")};h.prototype.destroy=function(){this.dom.remove();delete this};return h}(window,document,Green,Green._Utils,Green._EventHandler);Green._ChatWithListView=function(e,a,b,f,g,c){var d={};d.commit=function(){var h='<div class="pannel">'+'<div class="c-tit chatusr-tit"><i class="icon-comments"></i>洽谈列表</div>'+'<div class="usr-list"><div class="nano"><div class="nano-content"></div></div></div>'+"</div>";this.dom=$(h);this.chatWithViews=[];return this.dom};d.add=function(i){var h=this.get(i.id);if(h){return h}var j=new g(i);this.chatWithViews.push(j);this.dom.find(".nano-content").append(j.commit());this.dom.find(".nano").nanoScroller();return j};d.get=function(l){var j=this.chatWithViews;for(var k=0,h=j.length;k<h;k++){if(j[k].roster.id==l){return j[k]}}return false};d.prepend=function(h){this.get(h).dom.prependTo(this.dom.find(".nano-content"))};d.show=function(){this.dom.show()};d.hide=function(){this.dom.hide()};d.remove=function(j){var h=$.inArray(j,this.chatWithViews);if(j.dom.hasClass("active")){var i;if(h==this.chatWithViews.length-1){i=this.chatWithViews[h-1]}else{i=this.chatWithViews[h+1]}c.trigger("chatWithClick",[i])}this.chatWithViews.splice(h,1);j.destroy();this.dom.find(".nano").nanoScroller()};d.removeAll=function(){$.each(this.chatWithViews,function(i,h){h.destroy()});this.chatWithViews=[]};return d}(window,document,Green,Green._Utils,Green._ChatWithView,Green._EventHandler);Green._InputView=function(f,a,c,h,d){var b={};b.commit=function(){var i='<div class="send cf"><textarea  class="text" placeholder="按回车发送"></textarea><a href="javascript:void(0);" class="btn">发送</a></div>';this.dom=$(i);g.call(this);return this.dom};function g(){this.dom.find(".btn").click(function(){e.call(b);return false});this.dom.find(".text").keydown(function(i){if(i.which==13||i.which==10){e.call(b);return false}})}b.init=function(){h.freeTextarea(this.dom.find(".text"))};b.reset=function(){this.dom.find(".text").eq(0).val("").focus()};function e(){var i=this.dom.find(".text"),j=i.val();if(j==""){i.eq(0).focus();return false}d.trigger("sendMessageEnter",[j])}return b}(window,document,Green,Green._Utils,Green._EventHandler);Green._ChatboxView=function(e,g,b,d,j,i,h,c){var a={};a.commit=function(){var k='<div class="chatbox-wrap">'+'<div class="chatbox cf"><div class="c-tit cf"><div class="chat-with"><img src="" /><b class="chat-name"></b></div><div class="chat-opt"><i class="icon-minus"></i>&nbsp;<i class="icon-remove"></i>&nbsp;</div></div></div>'+'<div class="minus-pannel"><i class="icon-comments"></i><b class="cur-chat-name"></b></div>'+"</div>";this.dom=$(k);this.dom.prepend(i.commit());this.dom.find(".chatbox").append(h.commit());this.dom.find(".chatbox").append(c.commit());f.call(this);return this.dom};function f(){this.dom.find(".icon-minus").click(function(){a.minifiy();return false});this.dom.find(".minus-pannel").click(function(){j.trigger("chatboxMaxfiy");return false});this.dom.find(".icon-remove").click(function(){a.remove();return false})}a.get=function(k){return this.rosterViews[k]};a.toggle=function(k){if(k){this.dom.addClass("chatbox-wrap-contacts-minus")}else{this.dom.removeClass("chatbox-wrap-contacts-minus")}};a.isMinus=function(){return this.dom.hasClass("chatbox-minus")};a.maxfiy=function(){this.dom.removeClass("chatbox-minus");if(this.dom.hasClass("chat-new-message")){this.dom.removeClass("chat-new-message")}};a.minifiy=function(){return this.dom.addClass("chatbox-minus")};a.beMulti=function(){this.dom.addClass("multi-chatbox")};a.cleanMulti=function(){this.dom.removeClass("multi-chatbox")};a.hide=function(){return this.dom.hide()};a.show=function(){return this.dom.show()};a.remove=function(){i.removeAll();h.removeAll();this.hide()};return a}(window,document,Green,Green._Utils,Green._EventHandler,Green._ChatWithListView,Green._ConverseListView,Green._InputView);Green._Server=function(f,j,a,e,l){var d={};var b=0;var i=0;var o="0s66p2ntvx0q56pk5mh8wxa7cuegr57w5abvb7nwv5dqymyo";var n;d.isOpen=false;d.init=function(){n=new AVChatClient({appId:o,peerId:a.me.id,auth:p,watchingPeerIds:a.watch});n.on("close",function(q){h(q)});n.on("message",function(q){m(q)});n.on("online",function(q){c(q)});n.on("offline",function(q){g(q)});k()};function k(){if(!d.isOpen&&b==0){l.trigger("onConnectStart")}n.open().then(function(){d.isOpen=true;b=0;l.trigger("onConnectSuccess")},function(q){l.trigger("onConnectError")})}function m(r){var q={"from":r.fromPeerId,"to":r.peerId,"data":r.msg,"timestamp":r.timestamp};if(r.toPeerIds){q.to=r.toPeerIds[0]}l.trigger("messageReceived",[q])}function h(q){d.isOpen=false;if(b<i){b++;l.trigger("onReconnect",[b]);d.init()}else{l.trigger("onConnectClose")}}function c(s){for(var r=0,q=s.length;r<q;r++){if(s[r]==a.me.id){continue}l.trigger("online",[s[r]])}}function g(s){for(var r=0,q=s.length;r<q;r++){if(s[r]==a.me.id){continue}l.trigger("offline",[s[r]])}}function p(s,q,r){if(!d.authUrl){return false}return new Promise(function(u,t){$.post(d.authUrl,{self_id:s,watch_ids:q.join(":")}).success(function(v){v=$.parseJSON(v);u({n:v.nonce,t:v.timestamp,s:v.signature,sp:v.sp,watchingPeerIds:v.watchIds})}).error(function(v){t(v)})})}d.getRosters=function(){if(!this.rostersUrl){return false}var q=f.location.hash.split("#")[1]||1;$.ajax({type:"POST",url:this.rostersUrl+"?id="+q,timeout:10000,success:function(u){var t=$.parseJSON(u);if(t.length==0){return}a.me=t.me;a.me.id=a.me.id.toString();e.log('我的身份-<b style="color:red">'+a.me.name+"</b>");a.watch=[];var v={};for(var s=0,r=t.rosters.length;s<r;s++){t.rosters[s]["id"]=t.rosters[s]["id"].toString();a.watch.push(t.rosters[s]["id"]);v[t.rosters[s]["id"]]={id:t.rosters[s]["id"],name:t.rosters[s]["name"],image:t.rosters[s]["image"],unreadCount:0,onlineStatus:"offline",unreadMessages:[]}}a.rosters=v;l.trigger("getRostersSuccess")},error:function(){}})};d.getHistory=function(r,q){if(!this.conversationUrl){return false}$.ajax({type:"POST",url:this.conversationUrl,data:r,success:function(x){try{var v=$.parseJSON(x);var u=[];for(var t=0,s=v.length;t<s;t++){u.push({"from":v[t].from,"to":v[t].to[0],"data":v[t].data,"timestamp":v[t].timestamp})}}catch(w){var u=false}l.trigger("getHistorySuccess",[r,q,u])},error:function(){l.trigger("getHistoryFailed",[r,q])}})};d.sendMessage=function(q,r){n.send(q.data,q.to).then(function(){l.trigger("sendMessageSuccess",[q,r])},function(s){l.trigger("sendMessageFailed",[q,r])})};d.setRostersUrl=function(q){this.rostersUrl=q};d.setConversationUrl=function(q){this.conversationUrl=q};d.setAuthUrl=function(q){this.authUrl=q};return d}(window,document,Green,Green._Utils,Green._EventHandler);Green.init=function(g,h,c,f,n,b,a,k,j,d,m,e){c.debug=true;function l(){var p='<div class="greenchat"><div class="greenchat-inner"></div></div>';var q=$(p);q.append(m.commit());q.append(b.commit());q.append(a.commit(c.rosters));return q}function i(){$("body").append(l())}function o(p){if(p.rostersUrl){e.setRostersUrl(p.rostersUrl)}if(p.conversationUrl){e.setConversationUrl(p.conversationUrl)}if(p.authUrl){e.setAuthUrl(p.authUrl)}e.getRosters()}n.on("onConnectStart",function(){m.msg("聊天初始化中...")});n.on("onConnectSuccess",function(){m.hide()});n.on("onConnectClose",function(){m.msg("连接已断开，刷新重试")});n.on("onReconnect",function(p){m.msg("连接失败，重连中("+p+")...")});n.on("getRostersSuccess",function(){i();e.init();a.init();d.init();m.dom.css({height:a.height+"px",lineHeight:a.height+"px"})});n.on("rosterListViewToggle",function(p){a.toggle(p);b.toggle(p)});n.on("online",function(q){a.get(q).updateOnlineStatus("online");a.prepend(q);var p=k.get(q);if(p){p.updateOnlineStatus("online")}});n.on("offline",function(q){a.get(q).updateOnlineStatus("offline");var p=k.get(q);if(p){p.updateOnlineStatus("offline")}});n.on("rosterClick",function(p){b.show();var q=k.add(p.roster);if(k.chatWithViews.length>1){b.beMulti()}j.add(p.roster);n.trigger("chatWithClick",[q])});n.on("chatWithClick",function(q){var p=q.roster;a.get(p.id).updateUnread(0);q.updateUnread(0);q.active();j.front(p.id);j.currentView=j.get(p.id);j.currentView.scroll();if(b.isMinus){b.maxfiy()}b.dom.find(".chat-with img").attr("src",p.image);b.dom.find(".chat-with .chat-name").html(p.name);b.dom.find(".cur-chat-name").html(p.name)});n.on("chatWithRemove",function(p){k.remove(p);j.remove(p.roster.id);if(k.chatWithViews.length==1){b.cleanMulti()}});n.on("chatboxMaxfiy",function(){var p=j.currentView.roster.id;a.get(p).updateUnread(0);b.maxfiy()});n.on("sendMessageEnter",function(s){if(!e.isOpen){alert("连接已断开，刷新重试")}d.reset();var p=j.currentView;var r={from:c.me.id,to:p.roster.id,data:s,timestamp:new Date().getTime()};var q=p.renderMessage(r,"send");e.sendMessage(r,q)});n.on("sendMessageSuccess",function(q,p){p.addClass("send-success")});n.on("sendMessageFailed",function(q,p){p.addClass("send-failed")});n.on("getHistory",function(q,p){e.getHistory(q,p)});n.on("getHistorySuccess",function(r,p,q){if(q===false){p.showHistoryFailed();return false}if(!q||q.length==0){p.showNoHistory();return false}q.reverse();p.lastMessage=q[0];p.renderMessage(q,"history");if(q.length<30){p.showNoHistory()}else{p.showLoadmore()}});n.on("getHistoryFailed",function(q,p){p.showHistoryFailed()});n.on("messageReceived",function(t){if(t.from==c.me.id){if(j.get(t.to)){var u=k.get(t.to);n.trigger("chatWithClick",[u]);j.get(t.to).renderMessage(t,"receive");k.prepend(t.to)}else{var s=a.get(t.to);s.roster.unreadMessages.push(t);n.trigger("rosterClick",[s])}a.prepend(t.to);return false}var s=a.get(t.from);if(!s){return false}var q=s.roster.unreadCount;q++;a.prepend(t.from);if(j.get(t.from)){var u=k.get(t.from);var p=j.get(t.from);var r=j.currentView.roster.id==t.from;k.prepend(t.from);if(b.isMinus()){b.dom.addClass("chat-new-message");u.updateUnread(q);s.updateUnread(q);p.renderMessage(t,"notCurrent")}else{if(!r){u.updateUnread(q);s.updateUnread(q);p.renderMessage(t,"notCurrent")}else{p.renderMessage(t,"receive")}}}else{s.updateUnread(q);s.roster.unreadMessages.push(t)}});return o}(window,document,Green,Green._Utils,Green._EventHandler,Green._ChatboxView,Green._RosterListView,Green._ChatWithListView,Green._ConverseListView,Green._InputView,Green._StatusView,Green._Server);